{% extends 'base.html' %}
{% load static %}

{% block title %}{{ product.name }}{% endblock %}

{% block content %}
<div class="bg-gray-50 min-h-screen pt-16 lg:pt-20" dir="rtl">
    <div class="max-w-screen-xl mx-auto py-6 px-4 sm:px-6 lg:px-8 lg:py-10">

        <nav class="hidden lg:flex items-center text-sm text-gray-500 mb-8 font-medium">
            <a href="/" class="hover:text-indigo-600 transition duration-150">صفحه اصلی</a>
            <span class="mx-3">/</span>
            <a href="{{ product.category.get_absolute_url }}" class="hover:text-indigo-600 transition duration-150">{{ product.category.name }}</a>
            <span class="mx-3">/</span>
            <span class="text-gray-900 font-bold">{{ product.name }}</span>
        </nav>

        <div class="lg:hidden fixed bottom-0 left-0 right-0 bg-white border-t-2 border-indigo-100 shadow-2xl z-50 px-4 py-4">
            <div class="flex items-center justify-between">
                <div>
                    <div id="mobile-price" class="text-2xl font-black text-indigo-700 leading-none">{{ product.price|floatformat:0 }}</div>
                    <div class="text-sm text-gray-500 mt-1">تومان (مبلغ نهایی)</div>
                </div>
                <button class="bg-indigo-600 text-white px-8 py-3 rounded-xl font-bold text-lg shadow-lg add-to-cart-btn hover:bg-indigo-700 transition duration-300">
                    افزودن به سبد خرید
                </button>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-10 lg:gap-12">

            <div class="lg:col-span-8 order-1 lg:order-1">

                <div class="grid grid-cols-1 lg:grid-cols-7 gap-6 lg:gap-10">

                    <div class="lg:col-span-3">
                        <div class="lg:sticky lg:top-24 space-y-4">

                            <div id="mobile-gallery-wrapper" class="lg:hidden relative rounded-2xl overflow-hidden shadow-xl border border-gray-200">
                                <div id="mobile-gallery" class="flex transition-transform duration-500 ease-in-out">
                                    {% if product.main_image %}
                                        <div class="flex-shrink-0 w-full"><img src="{{ product.main_image.url }}" alt="{{ product.name }}" class="w-full h-80 object-cover"></div>
                                    {% endif %}
                                    {% for image in product.gallery.all %}
                                        <div class="flex-shrink-0 w-full"><img src="{{ image.image.url }}" alt="{{ product.name }} - عکس {{ forloop.counter }}" class="w-full h-80 object-cover"></div>
                                    {% endfor %}
                                </div>
                                <div id="mobile-dots" class="absolute bottom-3 left-0 right-0 flex justify-center gap-2">
                                    </div>
                            </div>

                            <div class="hidden lg:block relative rounded-3xl overflow-hidden shadow-xl bg-white border border-gray-200">
                                <img id="main-product-img" src="{{ product.main_image.url }}" alt="{{ product.name }}"
                                     class="w-full object-cover aspect-square transition-transform duration-700 hover:scale-105">
                            </div>

                            <div class="hidden lg:grid lg:grid-cols-5 gap-3">
                                {% with all_images=product.gallery.all %}
                                    {% if product.main_image %}
                                        <img src="{{ product.main_image.url }}" data-full="{{ product.main_image.url }}"
                                             class="gallery-thumb aspect-square object-cover rounded-xl cursor-pointer border-2 border-indigo-600 shadow-md">
                                    {% endif %}
                                    {% for image in all_images %}
                                        <img src="{{ image.image.url }}" data-full="{{ image.image.url }}"
                                             class="gallery-thumb aspect-square object-cover rounded-xl cursor-pointer border-2 border-gray-300 hover:border-indigo-500 transition">
                                    {% endfor %}
                                {% endwith %}
                            </div>
                        </div>
                    </div>

                    <div class="lg:col-span-4 space-y-8">

                        <div>
                            <h1 class="text-3xl lg:text-4xl font-black text-gray-900 leading-tight">
                                {{ product.name }}
                            </h1>
                            <p class="text-lg text-gray-600 mt-3 font-medium">
                                {{ product.short_description|default:"توضیحات کوتاه محصول در اینجا قرار می‌گیرد." }}
                            </p>
                            <div class="flex items-center gap-6 mt-6 text-gray-600">
                                <div class="flex items-center gap-2">
                                    <div class="flex text-yellow-500 text-lg">★★★★★</div>
                                    <span class="text-sm text-gray-500">(۳۵۴ نظر)</span>
                                </div>
                                <div class="text-sm flex items-center gap-2 font-medium text-green-600">
                                    <span class="w-2 h-2 bg-green-500 rounded-full"></span>
                                    موجود در انبار • ارسال فوری
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
                            <h3 class="text-xl font-bold text-gray-800 mb-6 border-b border-gray-100 pb-3">ویژگی‌های اصلی</h3>
                            <div class="grid grid-cols-1 gap-x-6 gap-y-8">
                                {% for feature in product.features.all %}
                                <div class="flex items-start gap-4">
                                    <div class="p-3 bg-indigo-50 rounded-xl flex-shrink-0">
                                        {# فرض می‌شود feature.icon.url آدرس آیکون است #}
                                        <img src="{{ feature.icon.url }}" class="w-6 h-6 text-indigo-700 opacity-80">
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-500">{{ feature.title }}</p>
                                        <p class="font-bold text-gray-900 text-sm lg:text-base">{{ feature.description }}</p>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>

                        <div class="space-y-4">
                            <h3 class="text-xl font-bold text-gray-800">انتخاب گزینه</h3>
                            <div class="space-y-3">
                                {% for variant in product.variants.all %}
                                <label class="variant-btn block cursor-pointer p-5 rounded-2xl border transition-all duration-200
                                    {% if variant.stock > 0 %}
                                        border-gray-300 hover:border-indigo-600 hover:bg-indigo-50/50
                                    {% else %}
                                        border-red-300 bg-red-50/70 opacity-70 cursor-not-allowed
                                    {% endif %}">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-4">
                                            <input type="radio" name="variant" value="{{ variant.id }}"
                                                   data-price="{{ variant.price|floatformat:0 }}" data-stock="{{ variant.stock }}"
                                                   class="w-5 h-5 text-indigo-600 border-gray-300 focus:ring-indigo-500"
                                                   {% if forloop.first %}checked{% endif %}
                                                   {% if variant.stock == 0 %}disabled{% endif %}>
                                            <div>
                                                <p class="font-bold text-gray-900">{{ variant.title }}</p>
                                                <p class="text-sm text-gray-500 mt-1">{{ variant.description }}</p>
                                            </div>
                                        </div>
                                        {% if variant.stock > 0 %}
                                            <div class="text-2xl font-black text-indigo-700 whitespace-nowrap">
                                                {{ variant.price|floatformat:0 }} <span class="text-sm font-normal text-gray-500 mr-1">تومان</span>
                                            </div>
                                        {% else %}
                                            <span class="text-red-600 font-bold">ناموجود</span>
                                        {% endif %}
                                    </div>
                                </label>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <div class="lg:col-span-4 order-3 lg:order-2">
                <div class="bg-white rounded-3xl shadow-2xl border border-gray-200 p-8 sticky top-24">

                    <div class="text-center mb-6 border-b-2 border-indigo-100 pb-6">
                        <h4 class="text-base text-gray-600 mb-2 font-medium">قیمت نهایی امروز:</h4>
                        <div id="final-price" class="text-5xl font-extrabold text-indigo-700 leading-none">
                            {% with first_variant=product.variants.all.first %}
                                {{ first_variant.price|floatformat:0 }}
                            {% endwith %}
                        </div>
                        <div class="text-xl text-gray-600 mt-2">تومان</div>
                    </div>

                    <div class="space-y-6">

                        <div class="flex items-center justify-center bg-green-50 text-green-700 px-5 py-3 rounded-xl text-center font-bold mb-8">
                            <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                            <span class="text-base">موجود در انبار • ارسال فوری</span>
                        </div>

                        <div class="flex items-center justify-between border-t border-gray-100 pt-6">
                            <span class="text-gray-700 font-bold text-lg">تعداد:</span>

                            <div class="flex items-center border border-gray-300 rounded-xl overflow-hidden divide-x divide-x-reverse divide-gray-300">

                                <button  type="button" onclick="changeQty(-1)" class="w-12 h-10 text-xl font-black text-gray-700 hover:bg-gray-100 transition">
                                    -
                                </button>

                                <input type="text" id="quantity" value="1"
                                    class="w-16 h-10 text-center font-bold text-lg text-gray-900 focus:outline-none bg-white border-0"
                                    readonly>

                                <button  type="button" onclick="changeQty(1)" class="w-12 h-10 text-xl font-black text-gray-700 hover:bg-gray-100 transition">
                                    +
                                </button>
                            </div>
                        </div>

                        <button class="w-full py-4 bg-indigo-600 text-white text-xl font-bold rounded-xl hover:bg-indigo-700 transition shadow-lg shadow-indigo-400/50 add-to-cart-btn mt-5">
                            افزودن به سبد خرید
                        </button>

                        <p class="text-center text-sm text-gray-500 border-t border-gray-100 pt-4">
                            ارائه شده با گارانتی ۱۸ ماهه اصلی و ضمانت اصالت کالا
                        </p>
                    </div>
                </div>
            </div>

        </div>

        <div class="mt-20 space-y-10 pb-20">

            <div class="bg-white rounded-3xl shadow-xl border border-gray-200 overflow-hidden">
                <div class="cursor-pointer select-none" onclick="toggleDescription()">
                    <div class="p-6 lg:p-8 border-b border-gray-100 hover:bg-gray-50 transition">
                        <div class="flex items-center justify-between">
                            <h2 class="text-xl lg:text-2xl font-black text-gray-900">توضیحات کامل محصول</h2>
                            <svg id="desc-icon" class="w-7 h-7 text-indigo-600 transition-transform duration-300 transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </div>
                        <div class="mt-4 text-gray-600 leading-relaxed text-sm lg:text-base">
                            <p>{{ product.description|truncatechars:200 }}</p>
                        </div>
                    </div>
                </div>
                <div id="full-description" class="max-h-0 overflow-hidden transition-all duration-500 ease-in-out">
                    <div class="p-6 lg:p-8 text-gray-700 leading-9 text-base lg:text-lg space-y-6">
                        {{ product.description|linebreaks }}
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-3xl shadow-xl border border-gray-200 overflow-hidden">
                <div class="cursor-pointer select-none" onclick="toggleSpecs()">
                    <div class="p-6 lg:p-8 border-b border-gray-100 hover:bg-gray-50 transition">
                        <div class="flex items-center justify-between">
                            <h2 class="text-xl lg:text-2xl font-black text-gray-900">مشخصات فنی و جزئیات</h2>
                            <svg id="specs-icon" class="w-7 h-7 text-indigo-600 transition-transform duration-300 transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </div>
                        <div class="grid grid-cols-2 gap-x-6 gap-y-3 mt-4 text-gray-700">
                            {% for spec in product.specifications.all|slice:':3' %}
                            <div class="truncate"><span class="text-gray-500 text-sm font-medium">{{ spec.title }}:</span>
                                <span class="font-semibold text-gray-800 ml-1">{{ spec.value }}</span></div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                <div id="full-specs" class="max-h-0 overflow-hidden transition-all duration-500">
                    <div class="p-6 lg:p-8 bg-gray-50">
                        <dl class="divide-y divide-gray-200">
                            {% for spec in product.specifications.all %}
                            <div class="py-3 sm:py-4 sm:grid sm:grid-cols-3 sm:gap-4">
                                <dt class="text-sm font-medium text-gray-500">{{ spec.title }}</dt>
                                <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2 font-bold">{{ spec.value }}</dd>
                            </div>
                            {% endfor %}
                        </dl>
                    </div>
                </div>
            </div>

        </div>

        <div class="mt-10 lg:mt-20 pb-10">
            <h2 class="text-2xl font-black text-gray-900 mb-8">نظرات خریداران (##)</h2>
            <div class="bg-white rounded-3xl shadow-xl border border-gray-200 p-8 text-center text-gray-600">
                <p class="text-lg">هنوز نظری ثبت نشده است. اولین نفری باشید که نظر خود را به اشتراک می‌گذارد.</p>
                <button class="mt-6 px-6 py-3 bg-indigo-50 text-indigo-600 font-bold rounded-xl hover:bg-indigo-100 transition duration-300">
                    ثبت نظر
                </button>
            </div>
        </div>

    </div>
</div>

<script>
// --- توابع جاوااسکریپت برای تعاملات UI ---

document.addEventListener('DOMContentLoaded', () => {

    // --- ۱. گالری تصاویر دسکتاپ ---
    const mainImg = document.getElementById('main-product-img');
    document.querySelectorAll('.gallery-thumb').forEach(thumb => {
        thumb.addEventListener('click', function() {
            // تغییر عکس اصلی
            mainImg.src = this.dataset.full;

            // هایلایت کردن thumbnail فعال
            document.querySelectorAll('.gallery-thumb').forEach(t => t.classList.remove('border-indigo-600', 'shadow-md'));
            document.querySelectorAll('.gallery-thumb').forEach(t => t.classList.add('border-gray-300'));
            this.classList.add('border-indigo-600', 'shadow-md');
            this.classList.remove('border-gray-300');
        });
    });

    // --- ۲. گالری تصاویر موبایل (اسلایدر/Carousel) ---
    const mobileGallery = document.getElementById('mobile-gallery');
    const galleryWrapper = document.getElementById('mobile-gallery-wrapper');
    const mobileDots = document.getElementById('mobile-dots');
    const slides = mobileGallery ? mobileGallery.children.length : 0;
    let currentIndex = 0;

    if (mobileGallery) {
        // ایجاد دات‌ها
        for (let i = 0; i < slides; i++) {
            const dot = document.createElement('span');
            dot.classList.add('w-2', 'h-2', 'rounded-full', 'cursor-pointer', 'transition');
            dot.classList.add(i === 0 ? 'bg-indigo-600' : 'bg-gray-300');
            dot.dataset.index = i;
            dot.addEventListener('click', () => updateMobileSlider(i));
            mobileDots.appendChild(dot);
        }

        // تابع به روزرسانی اسلایدر
        function updateMobileSlider(index) {
            if (mobileGallery && galleryWrapper) {
                mobileGallery.style.transform = `translateX(-${index * galleryWrapper.clientWidth}px)`;
                currentIndex = index;

                // به روزرسانی دات‌ها
                mobileDots.querySelectorAll('span').forEach((dot, i) => {
                    dot.classList.toggle('bg-indigo-600', i === index);
                    dot.classList.toggle('bg-gray-300', i !== index);
                });
            }
        }

        // منطق Drag/Swipe (اختیاری و پیچیده‌تر، اما برای سادگی در اینجا فقط از منطق دات‌ها استفاده می‌شود)

        // اطمینان از مقداردهی اولیه
        window.addEventListener('resize', () => updateMobileSlider(currentIndex));
        updateMobileSlider(0);
    }

    // --- ۳. بروزرسانی قیمت و استایل واریانت هنگام انتخاب ---
    document.querySelectorAll('input[name="variant"]').forEach(radio => {
        radio.addEventListener('change', () => {
            document.querySelectorAll('.variant-btn').forEach(btn => btn.classList.remove('border-indigo-600', 'bg-indigo-50/50'));

            if (radio.checked) {
                const price = radio.dataset.price;
                const formattedPrice = new Intl.NumberFormat('fa-IR').format(price);

                // به روزرسانی قیمت‌ها
                document.getElementById('final-price').textContent = formattedPrice;
                document.getElementById('mobile-price').textContent = formattedPrice;

                // استایل دادن به واریانت فعال
                radio.closest('.variant-btn').classList.add('border-indigo-600', 'bg-indigo-50/50');
            }
        });

        // اعمال استایل اولیه برای واریانت فعال (هنگام بارگذاری صفحه)
        if (radio.checked) {
             radio.closest('.variant-btn').classList.add('border-indigo-600', 'bg-indigo-50/50');
        }
    });

    // --- ۴. تنظیم اولیه ارتفاع برای آکاردئون‌ها ---
    const descSection = document.getElementById('full-description');
    const specsSection = document.getElementById('full-specs');
    if (descSection) descSection.style.maxHeight = '0px';
    if (specsSection) specsSection.style.maxHeight = '0px';

    // --- ۵. منطق افزودن به سبد خرید ---
    document.querySelectorAll('.add-to-cart-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const quantity = parseInt(document.getElementById('quantity').value);
            const variantInput = document.querySelector('input[name="variant"]:checked');

            if (!variantInput) {
                alert('لطفاً یک گزینه را انتخاب کنید');
                return;
            }
            if (variantInput.disabled) {
                alert('این گزینه موجود نیست.');
                return;
            }

            const variantId = variantInput.value;

            // این بخش نیازمند URL و منطق واقعی جنگو در بک‌اند شماست
            // fetch('{% url "add_to_cart" %}', {
            //     method: 'POST',
            //     headers: {
            //         'Content-Type': 'application/json',
            //         'X-CSRFToken': '{{ csrf_token }}'
            //     },
            //     body: JSON.stringify({
            //         product_id: '{{ product.id }}',
            //         variant_id: variantId,
            //         quantity: quantity
            //     })
            // })
            // .then(response => response.json())
            // .then(data => {
            //     alert('محصول به سبد خرید اضافه شد!');
            //     console.log(data);
            // })
            // .catch(err => console.error(err));

            alert(`محصول با ID: {{ product.id }} و گزینه ID: ${variantId} و تعداد ${quantity} آماده ارسال به بک‌اند است.`);
        });
    });

});

// --- توابع عمومی (برای onclick) ---

function toggleSection(sectionId, iconId) {
    const section = document.getElementById(sectionId);
    const icon = document.getElementById(iconId);

    const isClosed = section.style.maxHeight === '' || section.style.maxHeight === '0px';

    if (isClosed) {
        section.style.maxHeight = section.scrollHeight + "px";
        icon.classList.add('rotate-180');
    } else {
        // برای انیمیشن بهتر، ابتدا ارتفاع واقعی را تنظیم کرده و سپس آن را به 0px برمی‌گردانیم
        section.style.maxHeight = section.scrollHeight + "px";
        setTimeout(() => {
            section.style.maxHeight = '0px';
        }, 10);
        icon.classList.remove('rotate-180');
    }
}

window.toggleDescription = function() {
    // از آنجایی که متن مشاهده/بستن از داخل خود آکاردئون حذف شد، نیازی به آیدی متن نیست.
    toggleSection('full-description', 'desc-icon');
}

window.toggleSpecs = function() {
    toggleSection('full-specs', 'specs-icon');
}

window.changeQty = function(amount) {
    const qtyInput = document.getElementById('quantity');
    let qty = parseInt(qtyInput.value);
    qty += amount;
    if (qty < 1) qty = 1;
    qtyInput.value = qty;
}
</script>
{% endblock %}
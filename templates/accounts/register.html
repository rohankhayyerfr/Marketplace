{% extends 'base.html' %}
{% load i18n %}

{% block title %}{% trans "ثبت نام در سایت | شرکت لمون پارس" %}{% endblock %}

{% block content %}
<div class="min-h-screen flex items-center justify-center bg-gray-100 py-12 px-4 sm:px-6 lg:px-8" dir="rtl">

    <div class="max-w-md w-full space-y-8 bg-white p-10 rounded-3xl shadow-2xl">

        <div class="text-center">
            <svg class="mx-auto h-12 w-auto text-lime-600" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"></path>
            </svg>

            <h2 class="mt-6 text-3xl font-extrabold text-gray-900">
                {% trans "ایجاد حساب کاربری جدید" %}
            </h2>

            <p class="mt-2 text-sm text-gray-600">
                {% trans "قبلاً ثبت‌نام کرده‌اید؟" %}
                <a href="{% url 'accounts:login' %}"
                   class="font-medium text-lime-600 hover:text-lime-500 transition duration-150">
                    {% trans "وارد شوید" %}
                </a>
            </p>
        </div>

        <form id="register-form" class="mt-8 space-y-6" action="{% url 'accounts:register' %}" method="POST">
            {% csrf_token %}

            <div class="rounded-md shadow-sm space-y-4">

                <div class="grid grid-cols-2 gap-4">
                    <div class="field-container">
                        <label for="id_first_name" class="sr-only">{% trans "نام" %}</label>
                        <input id="id_first_name" name="first_name" type="text" required
                               class="input-field appearance-none relative block w-full px-4 py-3 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-lg focus:outline-none focus:ring-lime-500 focus:border-lime-500 sm:text-sm text-right"
                               placeholder="{% trans 'نام' %}">
                        <p class="error-message hidden text-sm text-red-600 mt-1"></p>
                    </div>

                    <div class="field-container">
                        <label for="id_last_name" class="sr-only">{% trans "نام خانوادگی" %}</label>
                        <input id="id_last_name" name="last_name" type="text" required
                               class="input-field appearance-none relative block w-full px-4 py-3 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-lg focus:outline-none focus:ring-lime-500 focus:border-lime-500 sm:text-sm text-right"
                               placeholder="{% trans 'نام خانوادگی' %}">
                        <p class="error-message hidden text-sm text-red-600 mt-1"></p>
                    </div>
                </div>

                <div class="field-container">
                    <label for="id_email" class="sr-only">{% trans "ایمیل" %}</label>
                    <input id="id_email" name="email" type="email" autocomplete="email" required
                           class="input-field appearance-none relative block w-full px-4 py-3 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-lg focus:outline-none focus:ring-lime-500 focus:border-lime-500 sm:text-sm text-right"
                           placeholder="{% trans 'آدرس ایمیل (فرمت صحیح)' %}">
                    <p class="error-message hidden text-sm text-red-600 mt-1"></p>
                </div>

                <div class="field-container">
                    <label for="id_username" class="sr-only">{% trans "نام کاربری" %}</label>
                    <input id="id_username" name="username" type="text" required minlength="5"
                           class="input-field appearance-none relative block w-full px-4 py-3 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-lg focus:outline-none focus:ring-lime-500 focus:border-lime-500 sm:text-sm text-right"
                           placeholder="{% trans 'نام کاربری (حداقل ۵ کاراکتر)' %}">
                    <p class="error-message hidden text-sm text-red-600 mt-1"></p>
                </div>

                <div class="field-container">
                    <label for="id_password" class="sr-only">{% trans "رمز عبور" %}</label>
                    <input id="id_password" name="password" type="password" autocomplete="new-password" required minlength="8"
                           class="input-field appearance-none relative block w-full px-4 py-3 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-lg focus:outline-none focus:ring-lime-500 focus:border-lime-500 sm:text-sm text-right"
                           placeholder="{% trans 'رمز عبور (حداقل ۸ کاراکتر و شامل عدد)' %}">
                    <p class="error-message hidden text-sm text-red-600 mt-1"></p>
                </div>

                <div class="field-container">
                    <label for="id_password2" class="sr-only">{% trans "تکرار رمز عبور" %}</label>
                    <input id="id_password2" name="password2" type="password" autocomplete="new-password" required
                           class="input-field appearance-none relative block w-full px-4 py-3 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-lg focus:outline-none focus:ring-lime-500 focus:border-lime-500 sm:text-sm text-right"
                           placeholder="{% trans 'تکرار رمز عبور' %}">
                    <p class="error-message hidden text-sm text-red-600 mt-1"></p>
                </div>
            </div>

            <div class="flex items-center text-sm">
                <label for="terms" class="ml-2 text-gray-900 select-none">
                    <span class="font-medium">
                        <a href="#" class="text-lime-600 hover:text-lime-500 transition duration-150">
                            {% trans "شرایط و قوانین" %}
                        </a>
                    </span>
                    {% trans "سایت را می‌پذیرم." %}
                </label>
                <input id="terms" name="terms" type="checkbox" required
                       class="h-4 w-4 text-lime-600 focus:ring-lime-500 border-gray-300 rounded">
            </div>

            <div>
                <button type="submit"
                        class="group relative w-full flex justify-center py-3 px-4 border border-transparent text-lg font-medium rounded-lg text-white bg-lime-600 hover:bg-lime-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-lime-500 transition duration-300 shadow-lg transform hover:scale-[1.01]">
                    {% trans "ثبت نام" %}
                </button>
            </div>

        </form>
    </div>
</div>


<script>
    const i18nMessages = {
        username_min: "{% trans 'نام کاربری باید حداقل ۵ کاراکتر باشد.' %}",
        email_invalid: "{% trans 'لطفاً یک آدرس ایمیل معتبر وارد کنید.' %}",
        password_min: "{% trans 'رمز عبور باید حداقل ۸ کاراکتر باشد.' %}",
        password_number: "{% trans 'رمز عبور باید شامل حداقل یک عدد باشد.' %}",
        password_mismatch: "{% trans 'تکرار رمز عبور با رمز عبور اصلی مطابقت ندارد.' %}",
    };
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('register-form');

        // تابع کمکی برای نمایش خطا
        function displayError(inputElement, message) {
            const container = inputElement.closest('.field-container');
            const errorMessageElement = container ? container.querySelector('.error-message') : null;

            // استایل دهی ورودی به قرمز
            inputElement.classList.add('border-red-500', 'focus:border-red-500', 'focus:ring-red-500');
            inputElement.classList.remove('focus:border-lime-500', 'focus:ring-lime-500', 'border-gray-300');

            // نمایش پیام خطا
            if (errorMessageElement) {
                errorMessageElement.textContent = message;
                errorMessageElement.classList.remove('hidden');
            }
        }

        // تابع کمکی برای پاک کردن خطا
        function clearError(inputElement) {
            const container = inputElement.closest('.field-container');
            const errorMessageElement = container ? container.querySelector('.error-message') : null;

            // بازگرداندن استایل به حالت عادی (تم لیمویی)
            inputElement.classList.remove('border-red-500', 'focus:border-red-500', 'focus:ring-red-500');
            inputElement.classList.add('focus:border-lime-500', 'focus:ring-lime-500', 'border-gray-300');

            // پنهان کردن پیام خطا
            if (errorMessageElement) {
                errorMessageElement.textContent = '';
                errorMessageElement.classList.add('hidden');
            }
        }

        form.addEventListener('submit', function(e) {
            e.preventDefault(); // جلوگیری از ارسال فرم پیش فرض

            // پاک کردن همه خطاهای قبلی
            document.querySelectorAll('.input-field').forEach(clearError);

            const password = document.getElementById('id_password');
            const password2 = document.getElementById('id_password2');
            const username = document.getElementById('id_username');
            const email = document.getElementById('id_email');

            let isValid = true;

            // 1. اعتبارسنجی نام کاربری (حداقل ۵ کاراکتر)
            if (username.value.length < 5) {
                displayError(username, 'نام کاربری باید حداقل ۵ کاراکتر باشد.');
                isValid = false;
            }

            // 2. اعتبارسنجی ایمیل
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email.value)) {
                 displayError(email, 'لطفاً یک آدرس ایمیل معتبر وارد کنید.');
                 isValid = false;
            }

            // 3. اعتبارسنجی رمز عبور (حداقل ۸ کاراکتر و شامل عدد)
            const hasNumber = /\d/.test(password.value);

            if (password.value.length < 8) {
                displayError(password, 'رمز عبور باید حداقل ۸ کاراکتر باشد.');
                isValid = false;
            } else if (!hasNumber) {
                displayError(password, 'رمز عبور باید شامل حداقل یک عدد باشد.');
                isValid = false;
            }

            // 4. اعتبارسنجی تطابق رمز عبور
            if (password.value !== password2.value) {
                displayError(password2, 'تکرار رمز عبور با رمز عبور اصلی مطابقت ندارد.');
                isValid = false;
            }

            // 5. اعتبارسنجی پذیرش شرایط و قوانین (توسط HTML5 انجام می‌شود اما جهت اطمینان)
            const termsChecked = document.getElementById('terms').checked;
            if (!termsChecked) {
                // معمولا نیازی به استایل دهی چک باکس نیست، اما باید لحاظ شود.
                isValid = false;
            }

            // ارسال نهایی فرم
            if (isValid) {
                form.submit();
            }
        });

        // افزودن ایونت listen برای پاک کردن خطا به محض شروع تایپ
        document.querySelectorAll('.input-field').forEach(input => {
            input.addEventListener('input', function() {
                clearError(this);
            });
        });
    });
</script>
{% endblock %}